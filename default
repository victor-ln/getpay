server {
# A porta é definida pela variável de ambiente do Azure
listen 8080;
listen [::]:8080;

# Define a raiz para a pasta 'public' do Laravel
root /home/site/wwwroot/public;
index index.php index.html index.htm;

charset utf-8;

# Configurações de timeout e tamanho de requisição
fastcgi_read_timeout 300;
client_max_body_size 100M;

# Logs
access_log /var/log/nginx/access.log;
error_log /var/log/nginx/error.log;

# Cabeçalhos de segurança
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;

# Regra principal do Laravel para URLs amigáveis
location / {
try_files $uri $uri/ /index.php?$query_string;
}

# [CORREÇÃO] A regra para evitar execução de PHP em pastas de upload
# foi movida para seu próprio bloco, antes da regra geral de PHP.
# Isso garante que ela seja avaliada primeiro.
location ~ /storage/.*\.php$ {
deny all;
return 403;
}

# Passa as requisições PHP para o PHP-FPM
location ~ \.php$ {
include fastcgi_params;
fastcgi_pass unix:/run/php/php-fpm.sock;
fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
fastcgi_param DOCUMENT_ROOT $realpath_root;
fastcgi_param PATH_INFO $fastcgi_path_info;
fastcgi_read_timeout 300;
}

# Nega acesso a arquivos sensíveis na raiz do projeto
location ~ /\.(ht|env|git) {
deny all;
return 404;
}

# Otimizações de cache para arquivos estáticos
location ~* \.(css|js|gif|ico|jpeg|jpg|png|svg|woff|woff2|ttf|eot)$ {
expires 1y;
add_header Cache-Control "public, immutable";
log_not_found off;
access_log off;
}

# Lida com favicon.ico para reduzir ruído nos logs
location = /favicon.ico {
log_not_found off;
access_log off;
}

# Lida com robots.txt
location = /robots.txt {
allow all;
log_not_found off;
access_log off;
}
}